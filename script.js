const data = [
  {
    "student_name":"أحمد محمد احمد العمري",
    "student_id":1149366674.0,
    "assignments":10,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":15.0,
    "short_practical":5,
    "period1_total":60.0,
    "final_practical":10.0,
    "final_written":27.75,
    "final_total":37.75
  },
  {
    "student_name":"اصيل صالح عبيد باواكد",
    "student_id":2282408810.0,
    "assignments":10,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":15.0,
    "short_practical":5,
    "period1_total":60.0,
    "final_practical":10.0,
    "final_written":28.5,
    "final_total":38.5
  },
  {
    "student_name":"أصيل هاني بن عطيه الجحدلي",
    "student_id":1152821326.0,
    "assignments":10,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":53.0,
    "final_practical":10.0,
    "final_written":21.25,
    "final_total":31.25
  },
  {
    "student_name":"انس محمد خالد الخليلي",
    "student_id":2290331699.0,
    "assignments":7,
    "projects":9,
    "activities":4,
    "participation":5,
    "short_written":6.0,
    "short_practical":5,
    "period1_total":36.0,
    "final_practical":9.0,
    "final_written":14.25,
    "final_total":23.25
  },
  {
    "student_name":"اياد بلقاسم احمد الصلبي",
    "student_id":1150958377.0,
    "assignments":9,
    "projects":10,
    "activities":6,
    "participation":9,
    "short_written":9.0,
    "short_practical":5,
    "period1_total":48.0,
    "final_practical":9.0,
    "final_written":11.0,
    "final_total":20.0
  },
  {
    "student_name":"ايمن حسين ابراهيم العامري",
    "student_id":160476931.0,
    "assignments":8,
    "projects":10,
    "activities":10,
    "participation":7,
    "short_written":11.75,
    "short_practical":5,
    "period1_total":51.75,
    "final_practical":10.0,
    "final_written":20.5,
    "final_total":30.5
  },
  {
    "student_name":"باسل علي سعد العمري",
    "student_id":1146213283.0,
    "assignments":10,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":15.0,
    "short_practical":5,
    "period1_total":60.0,
    "final_practical":10.0,
    "final_written":9.75,
    "final_total":19.75
  },
  {
    "student_name":"بسام ناصر جابر الجهني",
    "student_id":1158658946.0,
    "assignments":10,
    "projects":10,
    "activities":7,
    "participation":9,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":49.0,
    "final_practical":10.0,
    "final_written":10.5,
    "final_total":20.5
  },
  {
    "student_name":"توفيق معتصم ابراهيم حيدر",
    "student_id":1146748171.0,
    "assignments":2,
    "projects":5,
    "activities":3,
    "participation":1,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":24.0,
    "final_practical":8.0,
    "final_written":6.5,
    "final_total":14.5
  },
  {
    "student_name":"خالد عبدالمجيد نبيل عزوز",
    "student_id":1147763070.0,
    "assignments":8,
    "projects":10,
    "activities":9,
    "participation":10,
    "short_written":12.0,
    "short_practical":5,
    "period1_total":54.0,
    "final_practical":10.0,
    "final_written":22.75,
    "final_total":32.75
  },
  {
    "student_name":"رامي احمد سليمان عبيد",
    "student_id":2294729609.0,
    "assignments":5,
    "projects":6,
    "activities":6,
    "participation":4,
    "short_written":10.0,
    "short_practical":5,
    "period1_total":36.0,
    "final_practical":7.0,
    "final_written":14.75,
    "final_total":21.75
  },
  {
    "student_name":"رتان رائف سراج بكر",
    "student_id":1147904468.0,
    "assignments":5,
    "projects":8,
    "activities":5,
    "participation":1,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":32.0,
    "final_practical":3.0,
    "final_written":10.75,
    "final_total":13.75
  },
  {
    "student_name":"رياض حسين رياض الحسين",
    "student_id":5869558.0,
    "assignments":4,
    "projects":10,
    "activities":9,
    "participation":10,
    "short_written":5.0,
    "short_practical":5,
    "period1_total":43.0,
    "final_practical":10.0,
    "final_written":13.0,
    "final_total":23.0
  },
  {
    "student_name":"ريان عبدالرحمن قاسم مراد",
    "student_id":2267191241.0,
    "assignments":9,
    "projects":10,
    "activities":7,
    "participation":7,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":45.0,
    "final_practical":10.0,
    "final_written":17.0,
    "final_total":27.0
  },
  {
    "student_name":"زياد عائض عوض القحطاني",
    "student_id":1144163720.0,
    "assignments":10,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":15.0,
    "short_practical":5,
    "period1_total":60.0,
    "final_practical":10.0,
    "final_written":24.0,
    "final_total":34.0
  },
  {
    "student_name":"ساري نايف ابن حمد الجهني",
    "student_id":1148078320.0,
    "assignments":6,
    "projects":6,
    "activities":3,
    "participation":7,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":35.0,
    "final_practical":9.5,
    "final_written":9.25,
    "final_total":18.75
  },
  {
    "student_name":"سالم حسام سالم الحازمى",
    "student_id":1147532764.0,
    "assignments":10,
    "projects":10,
    "activities":6,
    "participation":9,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":47.0,
    "final_practical":9.0,
    "final_written":20.5,
    "final_total":29.5
  },
  {
    "student_name":"ساهر سعد سالم الترجمي",
    "student_id":1146644958.0,
    "assignments":7,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":13.0,
    "short_practical":5,
    "period1_total":55.0,
    "final_practical":10.0,
    "final_written":22.0,
    "final_total":32.0
  },
  {
    "student_name":"سطام احمد يوسف الحربي",
    "student_id":1143985453.0,
    "assignments":10,
    "projects":10,
    "activities":8,
    "participation":10,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":51.0,
    "final_practical":10.0,
    "final_written":14.5,
    "final_total":24.5
  },
  {
    "student_name":"شرف خالد عبدالله الشريف",
    "student_id":1147914251.0,
    "assignments":10,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":15.0,
    "short_practical":5,
    "period1_total":60.0,
    "final_practical":10.0,
    "final_written":22.0,
    "final_total":32.0
  },
  {
    "student_name":"صقر ناصر صقر العتيبي",
    "student_id":1148534074.0,
    "assignments":9,
    "projects":7,
    "activities":3,
    "participation":1,
    "short_written":3.0,
    "short_practical":5,
    "period1_total":28.0,
    "final_practical":6.0,
    "final_written":13.75,
    "final_total":19.75
  },
  {
    "student_name":"عادل احمد علي الزهراني",
    "student_id":1148257882.0,
    "assignments":8,
    "projects":10,
    "activities":9,
    "participation":10,
    "short_written":3.5,
    "short_practical":5,
    "period1_total":45.5,
    "final_practical":10.0,
    "final_written":22.5,
    "final_total":32.5
  },
  {
    "student_name":"عاصم اسامه رشدي الصفدي",
    "student_id":1147047920.0,
    "assignments":10,
    "projects":10,
    "activities":10,
    "participation":10,
    "short_written":15.0,
    "short_practical":5,
    "period1_total":60.0,
    "final_practical":10.0,
    "final_written":26.75,
    "final_total":36.75
  },
  {
    "student_name":"عبدالعزيز عوض عبدربه العولقي",
    "student_id":1157168913.0,
    "assignments":3,
    "projects":5,
    "activities":3,
    "participation":3,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":26.0,
    "final_practical":9.0,
    "final_written":13.25,
    "final_total":22.25
  },
  {
    "student_name":"عبدالقادر منير عبدالقادر محمد",
    "student_id":2269852659.0,
    "assignments":6,
    "projects":5,
    "activities":4,
    "participation":1,
    "short_written":4.0,
    "short_practical":5,
    "period1_total":25.0,
    "final_practical":8.0,
    "final_written":14.75,
    "final_total":22.75
  },
  {
    "student_name":"عبدالله حلمي عبدالله سالم",
    "student_id":2301843401.0,
    "assignments":8,
    "projects":1,
    "activities":4,
    "participation":1,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":26.0,
    "final_practical":3.0,
    "final_written":6.0,
    "final_total":9.0
  },
  {
    "student_name":"عبدالله نائف عبدالله السليماني",
    "student_id":1148551326.0,
    "assignments":8,
    "projects":1,
    "activities":10,
    "participation":7,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":39.0,
    "final_practical":7.0,
    "final_written":14.25,
    "final_total":21.25
  },
  {
    "student_name":"عبدالملك محمد حامد الزاهري",
    "student_id":1146069875.0,
    "assignments":3,
    "projects":8,
    "activities":4,
    "participation":7,
    "short_written":8.0,
    "short_practical":5,
    "period1_total":35.0,
    "final_practical":5.0,
    "final_written":10.75,
    "final_total":15.75
  },
  {
    "student_name":"علي صالح علي العمودي",
    "student_id":2277685141.0,
    "assignments":9,
    "projects":10,
    "activities":10,
    "participation":9,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":50.0,
    "final_practical":10.0,
    "final_written":15.75,
    "final_total":25.75
  },
  {
    "student_name":"عمار ابراهيم عبدالله المحوري",
    "student_id":1147815466.0,
    "assignments":4,
    "projects":6,
    "activities":3,
    "participation":4,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":29.0,
    "final_practical":10.0,
    "final_written":13.0,
    "final_total":23.0
  },
  {
    "student_name":"عمر عبدالرحمن سحيم السفياني",
    "student_id":1148388943.0,
    "assignments":9,
    "projects":10,
    "activities":9,
    "participation":10,
    "short_written":12.0,
    "short_practical":5,
    "period1_total":55.0,
    "final_practical":10.0,
    "final_written":21.75,
    "final_total":31.75
  },
  {
    "student_name":"محمد أحمد محمد الزهراني",
    "student_id":1148469917.0,
    "assignments":8,
    "projects":1,
    "activities":5,
    "participation":1,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":27.0,
    "final_practical":4.0,
    "final_written":13.0,
    "final_total":17.0
  },
  {
    "student_name":"نواف خالد بلغيث حكمي",
    "student_id":1146056203.0,
    "assignments":4,
    "projects":9,
    "activities":5,
    "participation":6,
    "short_written":7.0,
    "short_practical":5,
    "period1_total":36.0,
    "final_practical":9.0,
    "final_written":16.0,
    "final_total":25.0
  },
  {
    "student_name":"وليد عارف علي البشيري",
    "student_id":2278871591.0,
    "assignments":4,
    "projects":1,
    "activities":5,
    "participation":1,
    "short_written":5.0,
    "short_practical":5,
    "period1_total":21.0,
    "final_practical":3.0,
    "final_written":6.25,
    "final_total":9.25
  }
]


// === تحميل البيانات ===
// تم استبدال التحميل من JSON بمتغير داخلي
// const data = [...]; موجود في الأعلى

  document.getElementById("loadingCard").style.display = "none";
  const container = document.getElementById("cardsContainer");

  // أدوات تحليل البيانات
  const mean = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
  const median = arr => {
    const sorted = [...arr].sort((a, b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
  };
  const mode = arr => {
    const freq = {};
    arr.forEach(v => freq[v] = (freq[v] || 0) + 1);
    const maxFreq = Math.max(...Object.values(freq));
    return parseFloat(Object.keys(freq).find(k => freq[k] == maxFreq));
  };
  const stddev = (arr, avg) => Math.sqrt(arr.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / arr.length);

  // البيانات
  const period1 = data.map(s => s["period1_total"]);
  const final = data.map(s => s["final_practical"] + s["final_written"]);
  const grades = ["ممتاز مرتفع", "ممتاز", "جيد جدًا مرتفع", "جيد جدًا", "جيد مرتفع", "جيد", "مقبول مرتفع", "مقبول", "ضعيف"];
  const gradeCounts = {};
  data.forEach(s => {
    const grade = s["التقدير"] || "غير محدد";
    gradeCounts[grade] = (gradeCounts[grade] || 0) + 1;
  });

  // === البطاقة 1 ===
  const p1_mean = mean(period1), f_mean = mean(final);
  const p1_median = median(period1), f_median = median(final);
  const p1_mode = mode(period1), f_mode = mode(final);
  const p1_std = stddev(period1, p1_mean), f_std = stddev(final, f_mean);
  const p1_var = p1_std ** 2, f_var = f_std ** 2;
  const card1 = document.createElement("div");
  card1.className = "card";
  card1.innerHTML = `
    <h2>البطاقة 1: إحصائية مفصلة للفترتين</h2>
    <table><thead><tr><th>المؤشر</th><th>الفترة الأولى</th><th>نهاية الفصل</th></tr></thead>
    <tbody>
      <tr><td>عدد الطلاب</td><td>${period1.length}</td><td>${final.length}</td></tr>
      <tr><td>مجموع الدرجات</td><td>${period1.reduce((a,b)=>a+b,0).toFixed(2)}</td><td>${final.reduce((a,b)=>a+b,0).toFixed(2)}</td></tr>
      <tr><td>المتوسط</td><td>${p1_mean.toFixed(2)}</td><td>${f_mean.toFixed(2)}</td></tr>
      <tr><td>الوسيط</td><td>${p1_median.toFixed(2)}</td><td>${f_median.toFixed(2)}</td></tr>
      <tr><td>المنوال</td><td>${p1_mode}</td><td>${f_mode}</td></tr>
      <tr><td>الانحراف المعياري</td><td>${p1_std.toFixed(2)}</td><td>${f_std.toFixed(2)}</td></tr>
      <tr><td>التباين</td><td>${p1_var.toFixed(2)}</td><td>${f_var.toFixed(2)}</td></tr>
    </tbody></table>`;
  container.appendChild(card1);

  // === البطاقة 2 ===
  const indicators = [
    { label: "المتوسط", p1: p1_mean, f: f_mean },
    { label: "الوسيط", p1: p1_median, f: f_median },
    { label: "المنوال", p1: p1_mode, f: f_mode },
    { label: "الانحراف المعياري", p1: p1_std, f: f_std },
    { label: "التباين", p1: p1_var, f: f_var }
  ];
  const maxVal = Math.max(...indicators.flatMap(i => [i.p1, i.f]));
  const labels2 = indicators.map(i => i.label);
  const p1Data = indicators.map(i => ((i.p1 / maxVal) * 100).toFixed(2));
  const fData = indicators.map(i => ((i.f / maxVal) * 100).toFixed(2));
  const card2 = document.createElement("div");
  card2.className = "card";
  card2.innerHTML = `<h2>البطاقة 2: مقارنة المؤشرات (نسب مئوية)</h2><canvas id="comparisonChart"></canvas>`;
  container.appendChild(card2);
  new Chart(document.getElementById("comparisonChart").getContext("2d"), {
    type: 'bar',
    data: {
      labels: labels2,
      datasets: [
        { label: "الفترة الأولى", data: p1Data, backgroundColor: '#3498db' },
        { label: "نهاية الفصل", data: fData, backgroundColor: '#e74c3c' }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.label + ': ' + ctx.raw + '%'
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: value => value + '%'
          }
        }
      }
    }
  });

  // باقي البطاقات 3 إلى 12 ... (يتم إضافتها لاحقًا بنفس التنسيق)
}
